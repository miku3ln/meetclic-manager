# nginx.conf

worker_processes auto;                         # Ajusta automáticamente el número de procesos worker según la CPU

events {                                       # Bloque de configuración de eventos del motor
    worker_connections 1024;                   # Máximo de conexiones simultáneas por cada worker
}

# ---------- TCP STREAM PARA MYSQL ----------
stream {                                       # Bloque para proxy TCP/UDP (capa de transporte), ideal para MySQL
    upstream mysql_backend {                   # Grupo de servidores de backend TCP
        server db:3306;                        # Host/servicio Docker "db" escuchando MySQL en el puerto interno 3306
    }

    server {                                   # Servidor TCP que Nginx expone
        listen 3308;                           # Puerto TCP que Nginx atenderá para MySQL vía proxy
        proxy_connect_timeout 10s;             # Tiempo máximo para establecer la conexión con el backend
        proxy_timeout 1h;                      # Tiempo máximo de inactividad total permitido en la conexión proxificada
        proxy_pass mysql_backend;              # Redirige todo el tráfico entrante al upstream "mysql_backend"
    }
}

# ---------- HTTP PARA PHPMYADMIN ----------
http {                                         # Bloque de configuración HTTP (capa de aplicación)
    include       mime.types;                  # Tabla de tipos MIME para servir archivos con el Content-Type correcto
    default_type  application/octet-stream;    # Tipo por defecto cuando no se reconoce la extensión
    sendfile      on;                          # Usa sendfile() del kernel para servir archivos eficientemente
    keepalive_timeout  65;                     # Mantiene conexiones keep-alive abiertas hasta 65s

    client_max_body_size 256m;                 # (NUEVO) Tamaño máximo permitido de subida (debe cubrir tus .sql)
    client_body_timeout 3600s;                 # (NUEVO) Tiempo máximo para recibir el cuerpo (uploads largos)

    server {                                   # Servidor virtual HTTP
        listen 80;                             # Nginx escuchará en el puerto 80 dentro del contenedor
        server_name _;                         # Acepta cualquier valor de Host (comodín)

        # Proxy hacia phpMyAdmin
        location /pma/ {                       # Subruta pública para acceder a phpMyAdmin
            proxy_http_version 1.1;            # Usa HTTP/1.1 para soportar conexiones persistentes
            rewrite ^/pma/?(.*)$ /$1 break;    # Reescribe quitando el prefijo /pma antes de pasar al backend

            proxy_set_header Host              $host;                      # Reenvía el header Host original
            proxy_set_header X-Real-IP         $remote_addr;               # IP del cliente real
            proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for; # Cadena de proxies por los que pasó
            proxy_set_header X-Forwarded-Proto $scheme;                    # Protocolo original (http/https)

            proxy_connect_timeout 60s;         # (NUEVO) Tiempo para conectar con el backend phpMyAdmin
            proxy_read_timeout    3600s;       # (NUEVO) Tiempo máximo esperando respuesta del backend (import largo)
            proxy_send_timeout    3600s;       # (NUEVO) Tiempo máximo enviando datos hacia el backend
            send_timeout          3600s;       # (NUEVO) Tiempo máximo enviando datos al cliente
            proxy_request_buffering off;       # (NUEVO) Evita que Nginx bufee el body; envía el upload al backend a medida que llega

            proxy_pass http://phpmyadmin:80/;  # Envía las solicitudes al servicio Docker "phpmyadmin" en su puerto 80
        }

        access_log /var/log/nginx/access.log;  # Ruta del log de accesos (útil para diagnosticar)
        error_log  /var/log/nginx/error.log;   # Ruta del log de errores
    }
}
